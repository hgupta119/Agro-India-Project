<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agro India | Advanced Kisan Platform</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet Map CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #2ecc71;
            --primary-dark: #27ae60;
            --secondary: #2c3e50;
            --accent: #f39c12;
            --light: #f8f9fa;
            --dark: #2d3436;
            --danger: #e74c3c;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --glass: rgba(255, 255, 255, 0.95);
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; color: var(--secondary); margin: 0; padding: 0; overflow-x: hidden; }
        
        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes scan { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }

        .page { display: none; animation: fadeIn 0.4s ease-out; padding-top: 80px; min-height: 100vh; padding-bottom: 80px; }
        .active-page { display: block; }

        /* --- NAVBAR --- */
        .navbar {
            background: var(--secondary);
            color: white;
            padding: 1rem 5%;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .nav-links { display: flex; gap: 20px; align-items: center; }
        .nav-item { cursor: pointer; transition: color 0.3s; font-size: 0.95rem; }
        .nav-item:hover { color: var(--primary); }
        .nav-item.active { color: var(--primary); font-weight: 600; }
        
        .nav-btn {
            background: var(--primary);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            color: white;
            text-decoration: none;
            transition: 0.3s;
            cursor: pointer;
            border: none;
            font-family: inherit;
        }
        .nav-btn:hover { background: var(--primary-dark); }

        .cart-icon-container { position: relative; cursor: pointer; margin-right: 10px; display: none; }
        .cart-badge {
            position: absolute; top: -8px; right: -8px;
            background: var(--danger); color: white;
            border-radius: 50%; width: 18px; height: 18px;
            font-size: 0.7rem; display: flex; align-items: center; justify-content: center;
        }

        /* User Profile Section in Navbar */
        .user-profile { display: none; align-items: center; gap: 10px; }
        .user-name { font-weight: 600; color: var(--primary); }
        .logout-btn { background: var(--danger); padding: 5px 12px; font-size: 0.8rem; border-radius: 15px; cursor: pointer; }

        /* --- LAYOUT UTILS --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
        
        @media(max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
            .nav-links { display: none; } /* Simplified mobile handling */
        }

        /* --- HERO SECTION & WEATHER --- */
        .hero {
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1625246333195-581962374a1b?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
            background-position: center;
            height: 550px; /* Increased height for weather widget */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            border-radius: 0 0 30px 30px;
            margin-bottom: 40px;
            position: relative;
        }
        .hero-content h1 { font-size: 3rem; margin-bottom: 10px; }
        .hero-content p { font-size: 1.2rem; margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto; }

        /* WEATHER WIDGET STYLES */
        .weather-widget {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            padding: 15px 30px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 20px;
            margin-top: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            text-align: left;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            transition: transform 0.3s ease;
        }
        .weather-widget:hover { transform: translateY(-5px); }
        .weather-icon { font-size: 2.8rem; color: #ffeb3b; filter: drop-shadow(0 0 5px rgba(255,235,59,0.5)); }
        .weather-info h3 { margin: 0; font-size: 1.8rem; font-weight: 700; line-height: 1; }
        .weather-info p { margin: 0; font-size: 0.95rem; font-weight: 500; opacity: 0.9; }
        .weather-loc { font-size: 0.8rem; margin-top: 3px; display: block; opacity: 0.8; }

        /* --- CARDS --- */
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title { font-size: 1.25rem; font-weight: 600; color: var(--secondary); }
        
        /* --- BUTTONS --- */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .btn:hover { background: var(--primary-dark); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary); color: white; }
        .btn-voice { width: 50px; height: 50px; border-radius: 50%; background: var(--accent); position: fixed; bottom: 30px; right: 30px; box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4); display: flex; align-items: center; justify-content: center; z-index: 2000; cursor: pointer; font-size: 1.2rem; color: white; animation: pulse 2s infinite; }

        /* --- MAP & CHARTS --- */
        #map-container { height: 500px; width: 100%; border-radius: 15px; z-index: 1; }
        .chart-container { position: relative; height: 300px; width: 100%; }

        /* --- AI CROP DOCTOR --- */
        .scan-area {
            border: 3px dashed #cbd5e0;
            border-radius: 15px;
            height: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background: #f8fafc;
        }
        .scan-line {
            position: absolute; width: 100%; height: 4px; background: var(--danger);
            box-shadow: 0 0 10px var(--danger);
            display: none;
            animation: scan 2s linear infinite;
        }
        .scan-area.scanning .scan-line { display: block; }

        /* --- PRODUCTS --- */
        .product-img { width: 100%; height: 200px; object-fit: cover; border-radius: 10px; margin-bottom: 15px; }
        .price-tag { color: var(--primary-dark); font-weight: 700; font-size: 1.2rem; }

        /* --- TOAST NOTIFICATION --- */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 3000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 1rem;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center; justify-content: center;
            z-index: 2000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%; max-width: 500px;
            animation: fadeIn 0.3s;
            position: relative;
        }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #888; }
        .close-modal:hover { color: #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        .form-group input, .form-group select {
            width: 100%; padding: 10px;
            border: 1px solid #ddd; border-radius: 5px;
            font-family: inherit; font-size: 1rem;
        }
        .form-group input:focus { outline: none; border-color: var(--primary); }
        
        /* Auth Toggle */
        .auth-tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .auth-tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; font-weight: 600; color: #888; }
        .auth-tab.active { color: var(--primary); border-bottom: 2px solid var(--primary); }

        /* Cart Items */
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .cart-total { margin-top: 20px; font-size: 1.2rem; font-weight: 700; text-align: right; }
        
        /* Role Selection Cards */
        .role-cards { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
        .role-card {
            border: 2px solid #eee; border-radius: 15px; padding: 20px;
            text-align: center; cursor: pointer; width: 45%;
            transition: 0.3s;
        }
        .role-card:hover { border-color: var(--primary); background: #f0fdf4; transform: translateY(-5px); }
        .role-card i { font-size: 3rem; color: var(--secondary); margin-bottom: 10px; }
        .role-card.selected { border-color: var(--primary); background: #e1f5fe; }
        
        /* Quantity Input */
        .qty-controls { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 20px 0; }
        .qty-btn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #ccc; background: white; font-size: 1.2rem; cursor: pointer; }

        /* Order Tracker Styles */
        .order-step { display: flex; align-items: flex-start; margin-bottom: 20px; position: relative; }
        .order-step::before { content: ''; position: absolute; left: 15px; top: 30px; bottom: -20px; width: 2px; background: #ddd; }
        .order-step:last-child::before { display: none; }
        .step-icon { width: 32px; height: 32px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; z-index: 1; }
        .step-content h4 { margin: 0 0 5px 0; }
        .step-content p { margin: 0; color: #666; font-size: 0.9rem; }

        /* --- LANGUAGE TOGGLE --- */
        .lang-switch {
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.4);
            font-size: 0.8rem;
        }
    </style>
</head>
<body>

    <!-- NAVBAR -->
    <nav class="navbar">
        <div class="logo" onclick="nav('home')">
            <i class="fa-solid fa-leaf"></i> AgroIndia
        </div>
        <div class="nav-links">
            <span class="nav-item" onclick="nav('home')" data-lang="nav_home">Home</span>
            <span class="nav-item" onclick="nav('products')" data-lang="nav_market">Marketplace</span>
            <span class="nav-item" onclick="nav('map')" data-lang="nav_map">Live Map</span>
            <span class="nav-item" onclick="nav('insights')" data-lang="nav_insights">Analytics</span>
            <span class="nav-item" onclick="nav('ai-doctor')" data-lang="nav_ai" style="color: var(--accent);"> <i class="fa-solid fa-stethoscope"></i> Crop Doctor</span>
            <!-- Tracker Link (Visible to Buyers) -->
            <span class="nav-item" id="nav-tracker" onclick="nav('tracker')" style="display:none;">My Orders</span>

            
            <!-- Cart Icon (Buyer Only) -->
            <div class="cart-icon-container" id="nav-cart" onclick="openCartModal()">
                <i class="fa-solid fa-shopping-cart fa-lg"></i>
                <div class="cart-badge" id="cart-count">0</div>
            </div>

            <!-- Auth Section -->
            <button class="nav-btn" onclick="openAuthModal()" id="auth-btn">Login / Join</button>
            
            <!-- User Profile (Hidden by default) -->
            <div class="user-profile" id="user-profile">
                <span class="user-name" id="user-name-display">Hi, User</span>
                <span class="logout-btn" onclick="handleLogout()">Logout</span>
            </div>

            <div class="lang-switch" onclick="toggleLang()">Eng / Hi</div>
        </div>
    </nav>

    <!-- VOICE ASSISTANT FLOATING BUTTON -->
    <div class="btn-voice" onclick="startVoiceAssist()">
        <i class="fa-solid fa-microphone"></i>
    </div>

    <!-- 1. HOME PAGE -->
    <div id="home" class="page active-page">
        <div class="hero">
            <div class="hero-content">
                <h1 data-lang="hero_title">Empowering Indian Farmers</h1>
                <p data-lang="hero_desc">Advanced technology for smarter agriculture. Connect, Analyze, and Grow.</p>
                <button class="btn" onclick="nav('products')" data-lang="hero_btn">Explore Market</button>
                <br>
                <!-- REAL WEATHER WIDGET -->
                <div id="weather-widget" class="weather-widget" style="display:none;">
                    <div class="weather-icon"><i class="fa-solid fa-cloud-sun"></i></div>
                    <div class="weather-info">
                        <h3 id="weather-temp">--Â°C</h3>
                        <p id="weather-desc">Loading...</p>
                        <span class="weather-loc"><i class="fa-solid fa-location-dot"></i> New Delhi</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Stats Row -->
            <div class="grid-3" style="margin-bottom: 40px;">
                <div class="card" style="text-align: center;">
                    <i class="fa-solid fa-sack-dollar fa-3x" style="color: var(--primary); margin-bottom: 15px;"></i>
                    <h3 data-lang="feat_1_title">Fair Prices</h3>
                    <p data-lang="feat_1_desc">Direct Farmer-to-Consumer trading with zero commission.</p>
                </div>
                <div class="card" style="text-align: center;">
                    <i class="fa-solid fa-satellite-dish fa-3x" style="color: var(--accent); margin-bottom: 15px;"></i>
                    <h3 data-lang="feat_2_title">Smart Tech</h3>
                    <p data-lang="feat_2_desc">AI disease detection and Satellite monitoring.</p>
                </div>
                <div class="card" style="text-align: center;">
                    <i class="fa-solid fa-truck-fast fa-3x" style="color: var(--secondary); margin-bottom: 15px;"></i>
                    <h3 data-lang="feat_3_title">Fast Logistics</h3>
                    <p data-lang="feat_3_desc">Integrated supply chain for fresh delivery.</p>
                </div>
            </div>

            <!-- OUR MISSION SECTION -->
            <div class="card" style="margin-bottom: 40px; text-align: justify; border-left: 5px solid var(--accent);">
                <h2 style="color: var(--secondary); border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">Our Mission</h2>
                <p>1. At Agro India, our primary mission is to bridge the technological divide that currently exists in the Indian agricultural sector. We aim to empower every farmer, from smallholders to large-scale cultivators, with real-time data, direct market access, and advanced analytical tools. By eliminating intermediaries, we ensure that producers receive fair compensation for their hard work while consumers access fresh, high-quality produce at reasonable prices.</p>
                <p style="margin-top: 15px;">2. We are dedicated to fostering a sustainable agricultural ecosystem through the integration of cutting-edge technologies like Artificial Intelligence and Satellite Monitoring. Our platform serves as a digital companion for farmers, providing timely advice on crop health, weather patterns, and disease management, thereby reducing crop wastage and increasing overall yield productivity across the nation.</p>
                <p style="margin-top: 15px;">3. Furthermore, Agro India is committed to transparency and financial inclusion. By integrating government schemes and digital payment gateways directly into our platform, we strive to make financial resources and subsidies more accessible. We envision a future where Indian agriculture is not just a means of livelihood but a thriving, technology-driven industry that leads the world in efficiency and sustainability.</p>
            </div>
        </div>
    </div>

    <!-- 2. PRODUCTS PAGE -->
    <div id="products" class="page">
        <div class="container">
            <div class="card-header">
                <h2 data-lang="market_title">Digital Mandi</h2>
                <!-- Seller Only Button -->
                <button class="btn btn-outline" id="sell-btn" onclick="showPostModal()" style="display:none;"><i class="fa-solid fa-plus"></i> Sell Produce</button>
            </div>
            
            <div class="grid-3" id="product-grid">
                <!-- Products injected via JS -->
            </div>
        </div>
    </div>

    <!-- 3. LIVE MAP PAGE -->
    <div id="map" class="page">
        <div class="container">
            <h2 style="margin-bottom: 20px;">Live Mandi & Farm Locator</h2>
            <p>Real-time tracking of registered farms, cold storages, and Mandi prices.</p>
            <div class="card" style="padding: 10px;">
                <div id="map-container"></div>
            </div>
            <div class="grid-3" style="margin-top: 20px;">
                <div class="card" style="display:flex; align-items:center; gap:10px;">
                    <div style="width:20px; height:20px; background:red; border-radius:50%;"></div>
                    <span>Cold Storage</span>
                </div>
                <div class="card" style="display:flex; align-items:center; gap:10px;">
                    <div style="width:20px; height:20px; background:blue; border-radius:50%;"></div>
                    <span>APMC Mandi</span>
                </div>
                <div class="card" style="display:flex; align-items:center; gap:10px;">
                    <div style="width:20px; height:20px; background:green; border-radius:50%;"></div>
                    <span>Registered Farms</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. ANALYTICS PAGE (INSIGHTS) -->
    <div id="insights" class="page">
        <div class="container">
            <h2>Market Intelligence</h2>
            <p>AI-Driven Price Forecasts based on historical data.</p>
            
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Price Trend Analysis</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>
                <!-- Price Estimator Card (New) -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fa-solid fa-calculator"></i> Market Price Estimator</span>
                    </div>
                    <form onsubmit="handleRateEstimate(event)">
                        <div class="form-group">
                            <label>Select Crop</label>
                            <select id="est-crop" required>
                                <option value="Wheat">Wheat</option>
                                <option value="Rice">Rice</option>
                                <option value="Onion">Onion</option>
                                <option value="Potato">Potato</option>
                                <option value="Cotton">Cotton</option>
                            </select>
                        </div>
                        <button class="btn" style="width:100%">Get Estimate & Analysis</button>
                    </form>
                    <div id="est-result" style="margin-top:15px; padding:10px; background:#f0fdf4; border:1px solid #bbf7d0; border-radius:5px; display:none;">
                        <strong>Estimated Price:</strong> <span id="est-price-val" style="color:var(--primary-dark); font-size:1.2rem;">â‚¹0</span> / Quintal
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 30px;">
                <h3><i class="fa-solid fa-robot"></i> AI Prediction</h3>
                <p>Based on current weather patterns in your region (26Â°C, Sunny), we predict a <strong>15% increase</strong> in Onion prices over the next week. Recommended action: <strong>Hold Stock.</strong></p>
            </div>
        </div>
    </div>

    <!-- 5. AI CROP DOCTOR PAGE -->
    <div id="ai-doctor" class="page">
        <div class="container" style="max-width: 800px;">
            <div class="card" style="text-align: center;">
                <i class="fa-solid fa-user-doctor fa-3x" style="color: var(--accent); margin-bottom: 15px;"></i>
                <h2>AI Crop Disease Doctor</h2>
                <p>Upload a clear photo of an infected leaf. Our Deep Learning model will diagnose the issue.</p>
                
                <div class="scan-area" id="drop-zone" onclick="document.getElementById('file-upload').click()">
                    <div class="scan-line"></div>
                    <i class="fa-solid fa-cloud-arrow-up fa-3x" style="color: #cbd5e0;"></i>
                    <p style="margin-top: 15px;">Click to Upload or Drag Image</p>
                    <input type="file" id="file-upload" hidden accept="image/*" onchange="handleImageUpload(event)">
                    <img id="preview-img" style="display:none; max-height: 100%; max-width: 100%; z-index: 2;">
                </div>

                <div id="analysis-result" style="display: none; margin-top: 20px; text-align: left; background: #f0fdf4; padding: 20px; border-radius: 10px; border: 1px solid #bbf7d0;">
                    <h3 style="color: var(--primary-dark);"><i class="fa-solid fa-check-circle"></i> Diagnosis Complete</h3>
                    <p><strong>Detected:</strong> <span id="disease-name">Early Blight</span> (Confidence: 94%)</p>
                    <p><strong>Remedy:</strong> Spray Mancozeb 75% WP @ 2g/liter of water. Improve air circulation.</p>
                </div>
                
                <div id="loading-bar" style="display: none; width: 100%; background: #eee; height: 10px; border-radius: 5px; margin-top: 20px; overflow: hidden;">
                    <div style="width: 0%; height: 100%; background: var(--primary); transition: width 3s ease;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 6. TRACKER PAGE (NEW) -->
    <div id="tracker" class="page">
        <div class="container">
            <h2 style="margin-bottom: 20px;">My Orders Tracker</h2>
            <div id="orders-list">
                <!-- Orders injected here -->
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- AUTH MODAL (LOGIN/REGISTER) -->
    <div id="auth-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAuthModal()">&times;</span>
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')" id="tab-login">Login</div>
                <div class="auth-tab" onclick="switchAuthTab('register')" id="tab-register">Register</div>
            </div>

            <!-- Login Form -->
            <form id="form-login" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="login-email" required placeholder="user@example.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-pass" required placeholder="********">
                </div>
                <button type="submit" class="btn" style="width:100%">Login</button>
            </form>

            <!-- Register Form (NO ROLE SELECTION HERE) -->
            <form id="form-register" style="display:none;" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="reg-name" required placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="reg-email" required placeholder="user@example.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="reg-pass" required placeholder="********">
                </div>
                <button type="submit" class="btn" style="width:100%">Join Now</button>
            </form>
        </div>
    </div>

    <!-- ROLE SELECTION MODAL (NEW) -->
    <div id="role-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <h2 style="text-align:center; color: var(--secondary); margin-bottom: 20px;">Who are you?</h2>
            <div class="role-cards">
                <div class="role-card" onclick="selectRole('buyer')">
                    <i class="fa-solid fa-cart-shopping"></i>
                    <h3>Consumer / Buyer</h3>
                    <p>I want to buy fresh produce.</p>
                </div>
                <div class="role-card" onclick="selectRole('seller')">
                    <i class="fa-solid fa-tractor"></i>
                    <h3>Farmer / Seller</h3>
                    <p>I want to sell my crops.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- QUANTITY MODAL (NEW) -->
    <div id="quantity-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeQuantityModal()">&times;</span>
            <h3 id="qty-product-name" style="margin-top:0;">Product</h3>
            <p id="qty-product-price" style="color:var(--primary-dark); font-weight:bold;">â‚¹0 / Kg</p>
            
            <div class="form-group" style="text-align:center;">
                <label style="font-size:1.1rem; margin-bottom:15px;">Quantity (Kg)</label>
                <div class="qty-controls">
                    <button class="qty-btn" onclick="adjustQty(-1)">-</button>
                    <input type="number" id="qty-input" value="1" min="1" style="width:80px; text-align:center; font-size:1.2rem;">
                    <button class="qty-btn" onclick="adjustQty(1)">+</button>
                </div>
            </div>
            
            <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:15px; text-align:right;">
                Total: <strong id="qty-total-price" style="font-size:1.2rem;">â‚¹0</strong>
            </div>
            
            <button class="btn" style="width:100%" onclick="confirmAddToCart()">Add to Cart</button>
        </div>
    </div>

    <!-- CART MODAL -->
    <div id="cart-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0; color:var(--secondary);">Your Cart</h3>
                <span class="close-modal" onclick="closeCartModal()">&times;</span>
            </div>
            <div id="cart-items">
                <!-- Cart items injected here -->
                <p style="text-align:center; color:#888;">Your cart is empty.</p>
            </div>
            <div class="cart-total" id="cart-total-display">Total: â‚¹0</div>
            <button class="btn" style="width:100%; margin-top:20px;" onclick="openCheckout()">Proceed to Checkout</button>
        </div>
    </div>

    <!-- CHECKOUT MODAL -->
    <div id="checkout-modal" class="modal-overlay">
        <div class="modal-content">
             <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0; color:var(--secondary);">Checkout</h3>
                <span class="close-modal" onclick="closeCheckout()">&times;</span>
            </div>
            <form onsubmit="processPayment(event)">
                <div class="form-group">
                    <label>Delivery Address</label>
                    <input type="text" required placeholder="House No, Street, City">
                </div>
                <div class="form-group">
                    <label>Pincode</label>
                    <input type="number" required placeholder="110001">
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select required>
                        <option value="upi">UPI (GPay/PhonePe)</option>
                        <option value="cod">Cash on Delivery</option>
                        <option value="card">Credit/Debit Card</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Total Amount</label>
                    <input type="text" id="checkout-amount" disabled value="â‚¹0" style="background:#eee; font-weight:bold;">
                </div>
                <button type="submit" class="btn" style="width:100%" id="pay-btn">Pay Now</button>
            </form>
        </div>
    </div>

    <!-- SELL POST MODAL -->
    <div id="post-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0; color:var(--secondary);">Sell Your Produce</h3>
                <span class="close-modal" onclick="closePostModal()">&times;</span>
            </div>
            <form onsubmit="handleAddProduct(event)">
                <div class="form-group">
                    <label>Crop Name</label>
                    <input type="text" id="new-crop-name" required placeholder="e.g. Basmati Rice">
                </div>
                <div class="form-group">
                    <label>Price (â‚¹ per Kg)</label>
                    <input type="number" id="new-crop-price" required placeholder="e.g. 45">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="new-crop-loc" required placeholder="e.g. Nashik">
                </div>
                <div class="form-group">
                    <label>Contact Number</label>
                    <input type="tel" id="new-crop-contact" required placeholder="+91 9876543210">
                </div>
                <div class="form-group">
                    <label>Upload Image</label>
                    <input type="file" id="new-crop-img" accept="image/*" required>
                </div>
                <button type="submit" class="btn" style="width:100%">Post Listing</button>
            </form>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast">Notification</div>

    <script>
        // --- DATA & STATE ---
        const state = {
            lang: 'en',
            currentUser: null, // { name: string, role: 'buyer' | 'seller' }
            tempUser: null, // Holds user data before role selection
            users: [], // Simulating a database of registered users
            cart: [],
            orders: [], // Store past orders here
            // UPDATED PRICES TO BE PER KG
            products: [
                { id: 1, name: "Organic Wheat (Sharbati)", price: 28, unit: "Kg", img: "https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?auto=format&fit=crop&q=80&w=400", location: "Punjab", contact: "+91 98765 43210" },
                { id: 2, name: "Basmati Rice (Premium)", price: 65, unit: "Kg", img: "https://images.unsplash.com/photo-1586201375761-83865001e31c?auto=format&fit=crop&q=80&w=400", location: "Haryana", contact: "+91 98765 43211" },
                { id: 3, name: "Fresh Red Onions", price: 25, unit: "Kg", img: "https://images.unsplash.com/photo-1618512496248-a07fe83aa8cb?auto=format&fit=crop&q=80&w=400", location: "Nashik", contact: "+91 98765 43212" },
                { id: 4, name: "Kashmiri Apples", price: 150, unit: "Kg", img: "https://images.unsplash.com/photo-1560806887-1e4cd0b6cbd6?auto=format&fit=crop&q=80&w=400", location: "Srinagar", contact: "+91 98765 43213" },
                { id: 5, name: "Potatoes (Chandramukhi)", price: 20, unit: "Kg", img: "https://images.unsplash.com/photo-1518977676601-b53f82aba655?auto=format&fit=crop&q=80&w=400", location: "Agra", contact: "+91 98765 43214" },
                { id: 6, name: "Cotton", price: 80, unit: "Kg", img: "https://images.unsplash.com/photo-1595123550441-d377e017de6a?auto=format&fit=crop&q=80&w=400", location: "Gujarat", contact: "+91 98765 43215" },
            ],
            selectedProductForCart: null
        };

        const cropTrends = {
            'Wheat': [2100, 2150, 2200, 2400, 2350, 2800],
            'Rice': [2900, 2950, 3000, 3100, 3050, 3200],
            'Onion': [1200, 1500, 1800, 1600, 1900, 2500],
            'Potato': [800, 850, 900, 950, 1100, 1200],
            'Cotton': [5800, 5900, 6000, 6100, 6050, 6200]
        };

        const translations = {
            en: {
                hero_title: "Empowering Indian Farmers",
                hero_desc: "Advanced technology for smarter agriculture. Connect, Analyze, and Grow.",
                hero_btn: "Explore Market",
                nav_home: "Home", nav_market: "Marketplace", nav_map: "Live Map", nav_insights: "Analytics", nav_ai: "Crop Doctor",
                market_title: "Digital Mandi",
            },
            hi: {
                hero_title: "à¤­à¤¾à¤°à¤¤à¥€à¤¯ à¤•à¤¿à¤¸à¤¾à¤¨à¥‹à¤‚ à¤•à¤¾ à¤¸à¤¶à¤•à¥à¤¤à¤¿à¤•à¤°à¤£",
                hero_desc: "à¤¸à¥à¤®à¤¾à¤°à¥à¤Ÿ à¤–à¥‡à¤¤à¥€ à¤•à¥‡ à¤²à¤¿à¤ à¤‰à¤¨à¥à¤¨à¤¤ à¤¤à¤•à¤¨à¥€à¤•à¥¤ à¤œà¥à¤¡à¤¼à¥‡à¤‚, à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤•à¤°à¥‡à¤‚ à¤”à¤° à¤†à¤—à¥‡ à¤¬à¤¢à¤¼à¥‡à¤‚à¥¤",
                hero_btn: "à¤¬à¤¾à¤œà¤¼à¤¾à¤° à¤¦à¥‡à¤–à¥‡à¤‚",
                nav_home: "à¤¹à¥‹à¤®", nav_market: "à¤¬à¤¾à¤œà¤¼à¤¾à¤°", nav_map: "à¤¨à¤•à¥à¤¶à¤¾", nav_insights: "à¤°à¤¿à¤ªà¥‹à¤°à¥à¤Ÿ", nav_ai: "à¤«à¤¸à¤² à¤¡à¥‰à¤•à¥à¤Ÿà¤°",
                market_title: "à¤¡à¤¿à¤œà¤¿à¤Ÿà¤² à¤®à¤‚à¤¡à¥€",
            }
        };

        // --- NAVIGATION LOGIC ---
        function nav(pageId) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active-page'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(pageId).classList.add('active-page');
            
            if(pageId === 'map') initMap();
            if(pageId === 'insights') initCharts();
            if(pageId === 'products') renderProducts();
            if(pageId === 'tracker') renderTracker();
        }

        // --- AUTH LOGIC (Updated) ---
        function openAuthModal() {
            if(state.currentUser) {
                // If logged in, do nothing on this button. Logout handled via user profile.
            } else {
                document.getElementById('auth-modal').style.display = 'flex';
            }
        }
        function closeAuthModal() { document.getElementById('auth-modal').style.display = 'none'; }
        
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.getElementById('form-login').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('form-register').style.display = tab === 'register' ? 'block' : 'none';
        }

        async function handleLogin(e) {
            e.preventDefault();

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;

            try {
                // Ask Python Backend to verify user
                const response = await fetch('http://127.0.0.1:5000/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        email: email, 
                        password: password 
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    // Login Success
                    state.tempUser = { name: data.fullName, email: email }; 
                    showToast("Login Successful!");
                    closeAuthModal();
                    document.getElementById('role-modal').style.display = 'flex';
                } else {
                    // Login Failed (Wrong password or user not found)
                    showToast(data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                showToast("Server error. Is app.py running?");
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            // Get values from HTML forms
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-pass').value;

            // Send data to Python Backend (app.py)
            try {
                const response = await fetch('http://127.0.0.1:5000/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        full_name: name, 
                        email: email, 
                        password: password 
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    // Success! Store temp user for role selection
                    state.tempUser = { name: name, email: email };
                    showToast("Registration Successful!");
                    closeAuthModal();
                    document.getElementById('role-modal').style.display = 'flex';
                } else {
                    // Error from server (e.g., Email already exists)
                    showToast(data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                showToast("Server error. Is app.py running?");
            }
}

        function selectRole(role) {
            if(state.tempUser) {
                state.currentUser = { ...state.tempUser, role: role };
                state.tempUser = null;
                document.getElementById('role-modal').style.display = 'none';
                updateUI();
                showToast(`Welcome! Logged in as ${role === 'seller' ? 'Farmer' : 'Buyer'}`);
            }
        }

        function handleLogout() {
            state.currentUser = null;
            state.cart = [];
            state.orders = [];
            updateUI();
            nav('home'); // Go home
            showToast("Logged Out");
        }

        function updateUI() {
            const authBtn = document.getElementById('auth-btn');
            const userProfile = document.getElementById('user-profile');
            const userNameDisplay = document.getElementById('user-name-display');
            
            const sellBtn = document.getElementById('sell-btn');
            const cartIcon = document.getElementById('nav-cart');
            const trackerLink = document.getElementById('nav-tracker');
            
            if (state.currentUser) {
                authBtn.style.display = 'none';
                userProfile.style.display = 'flex';
                userNameDisplay.textContent = `Hi, ${state.currentUser.name}`;
                
                if (state.currentUser.role === 'seller') {
                    sellBtn.style.display = 'inline-block';
                    cartIcon.style.display = 'none';
                    trackerLink.style.display = 'none';
                } else {
                    sellBtn.style.display = 'none';
                    cartIcon.style.display = 'block';
                    trackerLink.style.display = 'inline-block';
                }
            } else {
                authBtn.style.display = 'block';
                userProfile.style.display = 'none';
                sellBtn.style.display = 'none';
                cartIcon.style.display = 'none';
                trackerLink.style.display = 'none';
            }
            updateCartCount();
        }

        // --- BUYING & QUANTITY LOGIC ---
        function openQuantityModal(productData) {
            if (!state.currentUser || state.currentUser.role !== 'buyer') {
                showToast("Please login as a Buyer to purchase.");
                openAuthModal();
                return;
            }
            state.selectedProductForCart = productData;
            document.getElementById('qty-product-name').textContent = productData.name;
            document.getElementById('qty-product-price').textContent = `â‚¹${productData.price} / Kg`;
            document.getElementById('qty-input').value = 1;
            updateQtyTotal();
            document.getElementById('quantity-modal').style.display = 'flex';
        }

        function closeQuantityModal() {
            document.getElementById('quantity-modal').style.display = 'none';
            state.selectedProductForCart = null;
        }

        function adjustQty(delta) {
            const input = document.getElementById('qty-input');
            let val = parseInt(input.value) + delta;
            if (val < 1) val = 1;
            input.value = val;
            updateQtyTotal();
        }

        document.getElementById('qty-input').addEventListener('input', updateQtyTotal);

        function updateQtyTotal() {
            const qty = parseInt(document.getElementById('qty-input').value) || 1;
            if(state.selectedProductForCart) {
                const total = qty * state.selectedProductForCart.price;
                document.getElementById('qty-total-price').textContent = `â‚¹${total}`;
            }
        }

        function confirmAddToCart() {
            if(!state.selectedProductForCart) return;
            const qty = parseInt(document.getElementById('qty-input').value) || 1;
            const item = {
                ...state.selectedProductForCart,
                qty: qty,
                totalPrice: qty * state.selectedProductForCart.price
            };
            
            state.cart.push(item);
            closeQuantityModal();
            updateCartCount();
            showToast(`Added ${qty}Kg to Cart`);
        }

        // --- CART LOGIC ---
        function updateCartCount() {
            document.getElementById('cart-count').textContent = state.cart.length;
        }

        function openCartModal() {
            const list = document.getElementById('cart-items');
            list.innerHTML = '';
            let total = 0;
            
            if(state.cart.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#888;">Your cart is empty.</p>';
            } else {
                state.cart.forEach((item, index) => {
                    total += item.totalPrice;
                    list.innerHTML += `
                        <div class="cart-item">
                            <div>
                                <strong>${item.name}</strong><br>
                                <small>${item.qty} Kg x â‚¹${item.price} = â‚¹${item.totalPrice}</small>
                            </div>
                            <button class="btn" style="background:var(--danger); padding: 5px 10px; font-size:0.8rem;" onclick="removeFromCart(${index})">Remove</button>
                        </div>
                    `;
                });
            }
            document.getElementById('cart-total-display').textContent = `Total: â‚¹${total}`;
            document.getElementById('cart-modal').style.display = 'flex';
        }

        function removeFromCart(index) {
            state.cart.splice(index, 1);
            openCartModal(); // Re-render
            updateCartCount();
        }

        function closeCartModal() { document.getElementById('cart-modal').style.display = 'none'; }

        // --- CHECKOUT LOGIC ---
        function openCheckout() {
            if(state.cart.length === 0) { showToast("Cart is empty"); return; }
            closeCartModal();
            let total = state.cart.reduce((sum, item) => sum + item.totalPrice, 0);
            document.getElementById('checkout-amount').value = `â‚¹${total}`;
            document.getElementById('checkout-modal').style.display = 'flex';
        }
        function closeCheckout() { document.getElementById('checkout-modal').style.display = 'none'; }

        function processPayment(e) {
            e.preventDefault();
            const btn = document.getElementById('pay-btn');
            const originalText = btn.textContent;
            btn.textContent = "Processing...";
            btn.disabled = true;

            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                
                // Create Order
                const newOrder = {
                    id: 'ORD-' + Math.floor(Math.random() * 10000),
                    items: [...state.cart],
                    total: state.cart.reduce((s, i) => s + i.totalPrice, 0),
                    date: new Date().toLocaleDateString(),
                    status: 'Processing'
                };
                state.orders.push(newOrder);

                closeCheckout();
                state.cart = []; // Clear Cart
                updateCartCount();
                showToast("Order Placed Successfully! ðŸŽ‰");
            }, 2000);
        }

        // --- ORDER TRACKER LOGIC ---
        function renderTracker() {
            const container = document.getElementById('orders-list');
            container.innerHTML = "";
            if(state.orders.length === 0) {
                container.innerHTML = "<p style='text-align:center;'>No orders found.</p>";
                return;
            }

            state.orders.forEach(order => {
                const itemNames = order.items.map(i => `${i.name} (${i.qty}Kg)`).join(", ");
                const html = `
                    <div class="card" style="margin-bottom:20px;">
                        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                            <strong>${order.id}</strong>
                            <span style="color:#666;">${order.date}</span>
                        </div>
                        <p><strong>Items:</strong> ${itemNames}</p>
                        <p><strong>Total:</strong> â‚¹${order.total}</p>
                        
                        <div style="margin-top:20px;">
                            <div class="order-step">
                                <div class="step-icon"><i class="fa-solid fa-box"></i></div>
                                <div class="step-content">
                                    <h4>Order Placed</h4>
                                    <p>Your order has been received.</p>
                                </div>
                            </div>
                            <div class="order-step">
                                <div class="step-icon" style="background:#ddd;"><i class="fa-solid fa-truck"></i></div>
                                <div class="step-content">
                                    <h4>Shipped</h4>
                                    <p>Pending dispatch.</p>
                                </div>
                            </div>
                            <div class="order-step">
                                <div class="step-icon" style="background:#ddd;"><i class="fa-solid fa-check"></i></div>
                                <div class="step-content">
                                    <h4>Delivered</h4>
                                    <p>Estimated delivery in 3 days.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // --- MAP, CHART, MARKETPLACE, AI DOCTOR ---
        let map;
        function initMap() {
            setTimeout(() => {
                if (map) { map.invalidateSize(); return; }
                map = L.map('map-container').setView([22.9734, 78.6569], 5);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap contributors' }).addTo(map);
                const locations = [
                    { lat: 28.7041, lng: 77.1025, title: "Azadpur Mandi (Delhi)", type: "mandi", color: "blue" },
                    { lat: 19.9975, lng: 73.7898, title: "Nashik Onion Market", type: "mandi", color: "blue" },
                    { lat: 30.7333, lng: 76.7794, title: "Punjab Wheat Storage", type: "storage", color: "red" },
                    { lat: 23.0225, lng: 72.5714, title: "Gujarat Cotton Farms", type: "farm", color: "green" },
                ];
                locations.forEach(loc => {
                    L.circleMarker([loc.lat, loc.lng], { radius: 8, fillColor: loc.color, color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.8 }).addTo(map).bindPopup(`<b>${loc.title}</b><br>Type: ${loc.type.toUpperCase()}`);
                });
            }, 200);
        }

        let priceChart, cropChart;
        function initCharts() {
            if(priceChart) return; 
            const ctx1 = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{ label: 'Wheat Price (â‚¹/Quintal)', data: [2100, 2150, 2200, 2400, 2350, 2800], borderColor: '#2ecc71', backgroundColor: 'rgba(46, 204, 113, 0.2)', fill: true, tension: 0.4 }]
                }, options: { responsive: true, maintainAspectRatio: false }
            });
            // REMOVED cropPieChart code to fix the error
        }

        // Rate Estimator Logic
        function handleRateEstimate(e) {
            e.preventDefault();
            const crop = document.getElementById('est-crop').value;
            let baseRate = 0;
            switch(crop) {
                case 'Wheat': baseRate = 2200; break;
                case 'Rice': baseRate = 3000; break;
                case 'Onion': baseRate = 1800; break;
                case 'Potato': baseRate = 1200; break;
                case 'Cotton': baseRate = 6000; break;
            }
            // Add fluctuation
            const random = Math.floor(Math.random() * 200) - 100;
            const final = baseRate + random;
            
            document.getElementById('est-price-val').textContent = `â‚¹${final}`;
            document.getElementById('est-result').style.display = 'block';

            // UPDATE CHART DYNAMICALLY
            if(priceChart && cropTrends[crop]) {
                priceChart.data.datasets[0].data = cropTrends[crop];
                priceChart.data.datasets[0].label = `${crop} Price (â‚¹/Quintal)`;
                priceChart.update();
            }
        }

        function renderProducts() {
            const container = document.getElementById('product-grid');
            if(container.innerHTML.trim() !== "") container.innerHTML = ""; 
            state.products.forEach(p => {
                const pString = JSON.stringify(p).replace(/"/g, '&quot;');
                const html = `
                    <div class="card">
                        <img src="${p.img}" class="product-img" alt="${p.name}">
                        <div class="card-header" style="margin-bottom:5px;">
                            <span class="card-title" style="font-size: 1.1rem;">${p.name}</span>
                            <span style="font-size:0.8rem; color:grey;"><i class="fa-solid fa-location-dot"></i> ${p.location}</span>
                        </div>
                        <p style="font-size:0.8rem; color:#555; margin-top:5px;"><i class="fa-solid fa-phone"></i> ${p.contact || 'Not provided'}</p>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="price-tag">â‚¹${p.price}/${p.unit}</span>
                            <button class="btn" onclick="openQuantityModal(${pString})">Buy</button>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function showPostModal() { document.getElementById('post-modal').style.display = 'flex'; }
        function closePostModal() { document.getElementById('post-modal').style.display = 'none'; }

        function handleAddProduct(e) {
            e.preventDefault();
            const name = document.getElementById('new-crop-name').value;
            const price = document.getElementById('new-crop-price').value;
            const loc = document.getElementById('new-crop-loc').value;
            const contact = document.getElementById('new-crop-contact').value;
            const fileInput = document.getElementById('new-crop-img');
            
            if(fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const newProduct = { 
                        id: Date.now(), 
                        name: name, 
                        price: parseInt(price), 
                        unit: "Kg", 
                        img: e.target.result, // Use uploaded image data URL
                        location: loc,
                        contact: contact
                    };
                    state.products.unshift(newProduct);
                    renderProducts();
                    closePostModal();
                    showToast("Listing Posted Successfully!");
                    document.getElementById('new-crop-img').value = ''; // Reset input
                }
                reader.readAsDataURL(fileInput.files[0]);
            }
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('preview-img');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    document.querySelector('.fa-cloud-arrow-up').style.display = 'none';
                }
                reader.readAsDataURL(file);
                const scanArea = document.querySelector('.scan-area');
                scanArea.classList.add('scanning');
                const loader = document.getElementById('loading-bar');
                const fill = loader.querySelector('div');
                const result = document.getElementById('analysis-result');
                result.style.display = 'none';
                loader.style.display = 'block';
                setTimeout(() => { fill.style.width = '100%'; }, 100);
                setTimeout(() => {
                    scanArea.classList.remove('scanning');
                    loader.style.display = 'none';
                    fill.style.width = '0%';
                    const diseases = [ { name: "Leaf Rust", remedy: "Use Propiconazole 25% EC" }, { name: "Powdery Mildew", remedy: "Spray Sulphur based fungicide" }, { name: "Healthy Crop", remedy: "No action needed. Keep monitoring." } ];
                    const random = diseases[Math.floor(Math.random() * diseases.length)];
                    document.getElementById('disease-name').textContent = random.name;
                    result.querySelector('p:nth-child(3)').innerHTML = `<strong>Remedy:</strong> ${random.remedy}`;
                    result.style.display = 'block';
                    showToast("Analysis Complete!");
                }, 3000);
            }
        }

        function startVoiceAssist() {
            if ('webkitSpeechRecognition' in window) {
                const recognition = new webkitSpeechRecognition();
                recognition.lang = state.lang === 'en' ? 'en-US' : 'hi-IN';
                showToast("Listening... (Speak 'Market' or 'Map')");
                recognition.onresult = function(event) {
                    const command = event.results[0][0].transcript.toLowerCase();
                    showToast(`Heard: "${command}"`);
                    if(command.includes('market') || command.includes('bajar')) nav('products');
                    else if(command.includes('map') || command.includes('naksha')) nav('map');
                    else if(command.includes('home') || command.includes('ghar')) nav('home');
                    else showToast("Command not recognized");
                };
                recognition.start();
            } else { alert("Voice API not supported in this browser. Try Chrome."); }
        }

        function toggleLang() {
            state.lang = state.lang === 'en' ? 'hi' : 'en';
            for (const [key, value] of Object.entries(translations[state.lang])) {
                const el = document.querySelector(`[data-lang="${key}"]`);
                if(el) el.textContent = value;
            }
            showToast(`Language switched to ${state.lang === 'en' ? 'English' : 'Hindi'}`);
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.className = "show";
            toast.textContent = message;
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // --- REAL WEATHER WIDGET LOGIC ---
        async function fetchWeather() {
            try {
                // New Delhi Coordinates
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=28.6139&longitude=77.2090&current_weather=true');
                const data = await response.json();
                const temp = data.current_weather.temperature;
                const code = data.current_weather.weathercode;
                
                let desc = "Clear Sky";
                let icon = "fa-sun";
                
                // Simple WMO code mapping
                if(code > 0 && code <= 3) { desc = "Partly Cloudy"; icon = "fa-cloud-sun"; }
                else if(code > 40 && code < 60) { desc = "Foggy"; icon = "fa-smog"; }
                else if(code >= 60 && code < 80) { desc = "Rainy"; icon = "fa-cloud-rain"; }
                else if(code >= 80) { desc = "Thunderstorm"; icon = "fa-cloud-bolt"; }

                document.getElementById('weather-temp').textContent = `${temp}Â°C`;
                document.getElementById('weather-desc').textContent = desc;
                document.querySelector('.weather-icon i').className = `fa-solid ${icon}`;
                document.getElementById('weather-widget').style.display = 'inline-flex';
            } catch (e) {
                console.error("Weather fetch failed", e);
            }
        }

        // Init weather on load
        fetchWeather();

    </script>
</body>
</html>